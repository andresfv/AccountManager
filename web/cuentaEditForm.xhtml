<?xml version='1.0' encoding='UTF-8' ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<ui:composition template="index.xhtml"
                xmlns="http://www.w3.org/1999/xhtml"
                xmlns:h="http://xmlns.jcp.org/jsf/html"
                xmlns:f="http://xmlns.jcp.org/jsf/core"
                xmlns:ui="http://xmlns.jcp.org/jsf/facelets"
                xmlns:p="http://primefaces.org/ui">
    <ui:define name="center">
        <f:event type="preRenderView" listener="#{cuentaBean.initDefaults}"/>
        <f:event type="preRenderView" listener="#{movimientoBean.initDefaults}"/>
        <f:event type="preRenderView" listener="#{cuentaBean.initDetails}"/>

        <p:menubar>
            <p:menuitem id="cuentaSaveCommandButton"
                        value="Guardar"
                        icon="ui-icon-disk"
                        action="#{cuentaBean.onSave()}"
                        update="#{p:component('messages')}"
                        process="@form, nombreCuentaInputText" />

            <p:menuitem value="Regresar" 
                        url="/faces/cuentaListForm.xhtml" 
                        icon="ui-icon-arrowreturnthick-1-w" />
        </p:menubar>

        <h:panelGrid columns="2">
            <p:outputLabel id='cargaArchivoExcelOutputLabel'
                           value="Cargar desde archivo excel"
                           for="cargaArchivoExcel"/>

            <p:fileUpload id="cargaArchivoExcel"
                          fileUploadListener="#{cuentaBean.handleFileUpload}"
                          mode="advanced" 
                          auto="true"
                          dragDropSupport="false"
                          update="messages, movimientoDataTable, totalesOutputPanel" 
                          allowTypes="/(\.|\/)(xls|xlsx)$/" 
                          invalidFileMessage="Solo se admiten formatos xls o xlsx"/>
        </h:panelGrid>
        <p:panel id='cuentaPanel'
                 header="Mantenimiento de Cuenta">

            <h:panelGrid columns="2">
                <p:outputLabel id='nombreCuentaOutputLabel'
                               value="Nombre"
                               for="nombreCuentaInputText"/>
                <p:inputText id="nombreCuentaInputText"
                             value="#{cuentaBean.cuenta.nombre}"
                             required="true"/>

            </h:panelGrid>
            
            <p:fieldset legend="Filtros" toggleable="true" toggleSpeed="500" collapsed="true">
                <p:fieldset legend="Filtrar por cuenta">
                    <h:panelGrid columns="2">
                        <p:outputLabel id='cuentaOutputLabel'
                                       value="Cuenta"
                                       for="cuentaSelectOneMenu"/>

                        <p:selectOneMenu id="cuentaSelectOneMenu"
                                         value="#{cuentaBean.cuenta.idCuenta}">
                            <f:selectItem itemLabel="Todos" itemValue="" noSelectionOption="true"/>
                            <f:selectItems value="#{cuentaBean.llenarCuentas()}"/>
                            <p:ajax process="@this"
                                    event="change"
                                    update="movimientoDataTable, totalesOutputPanel"
                                    listener="#{cuentaBean.consultaMovimientosCuenta()}"/>
                        </p:selectOneMenu>
                    </h:panelGrid>
                </p:fieldset>
                <p:fieldset legend="Filtrar por fecha movimiento">
                    <h:panelGrid columns="4">
                        <p:outputLabel id='mesLabel'
                                       value="Mes"
                                       for="mesSelectOneMenu"/>
                        <p:selectOneMenu id="mesSelectOneMenu"
                                         value="#{cuentaBean.mes}">
                            <f:selectItem itemLabel="Enero" itemValue="0"/>
                            <f:selectItem itemLabel="Febrero" itemValue="1"/>
                            <f:selectItem itemLabel="Marzo" itemValue="2"/>
                            <f:selectItem itemLabel="Abril" itemValue="3"/>
                            <f:selectItem itemLabel="Mayo" itemValue="4"/>
                            <f:selectItem itemLabel="Junio" itemValue="5"/>
                            <f:selectItem itemLabel="Julio" itemValue="6"/>
                            <f:selectItem itemLabel="Agosto" itemValue="7"/>
                            <f:selectItem itemLabel="Septiembre" itemValue="8"/>
                            <f:selectItem itemLabel="Octubre" itemValue="9"/>
                            <f:selectItem itemLabel="Noviembre" itemValue="10"/>
                            <f:selectItem itemLabel="Diciembre" itemValue="11"/>

                            <p:ajax process="@this"
                                    event="change"
                                    update="movimientoDataTable, 
                                    totalesOutputPanel, 
                                    fechaDesdeCalendar, 
                                    fechaHastaCalendar"
                                    listener="#{cuentaBean.consultaMovimientosCuenta()}"/>
                        </p:selectOneMenu>
                        <p:outputLabel id='fechaDesdeOutputLabel'
                                       value="Desde"
                                       for="fechaDesdeCalendar"/>
                        <p:calendar id="fechaDesdeCalendar" 
                                    value="#{cuentaBean.fechaDesde}"
                                    showOn="button"
                                    locale="es"
                                    navigator="true"
                                    pattern="dd/MM/yyyy"
                                    required="true">
                            <p:ajax process="@this"
                                    update="mesSelectOneMenu, anioSelectOneMenu, movimientoDataTable, totalesOutputPanel"
                                    event="dateSelect"
                                    listener="#{cuentaBean.consultaMovimientosCuenta()}"/>
                        </p:calendar>
                        <p:outputLabel id='anioLabel'
                                       value="Año"
                                       for="anioSelectOneMenu"/>
                        <p:selectOneMenu id="anioSelectOneMenu"
                                         value="#{cuentaBean.anio}">           
                            <f:selectItems value="#{cuentaBean.cargaListaAnios()}"/>
                            <p:ajax process="@this"
                                    event="change"
                                    update="movimientoDataTable, 
                                    totalesOutputPanel, 
                                    fechaDesdeCalendar, 
                                    fechaHastaCalendar"
                                    listener="#{cuentaBean.consultaMovimientosCuenta()}"/>
                        </p:selectOneMenu>

                        <p:outputLabel id='fechaHastaOutputLabel'
                                       value="Hasta"
                                       for="fechaHastaCalendar"/>
                        <p:calendar id="fechaHastaCalendar" 
                                    value="#{cuentaBean.fechaHasta}"
                                    showOn="button"
                                    locale="es"
                                    navigator="true"
                                    pattern="dd/MM/yyyy"
                                    required="true">
                            <p:ajax process="@this"
                                    update="movimientoDataTable, totalesOutputPanel"
                                    event="dateSelect"
                                    listener="#{cuentaBean.consultaMovimientosCuenta()}"/>
                        </p:calendar>

                    </h:panelGrid>
                </p:fieldset>
            </p:fieldset>

            <p:dataTable id="movimientoDataTable"
                         widgetVar="movimientoDataTable"
                         var="object" 
                         value="#{cuentaBean.listaMovimientos}"
                         rows="10"
                         scrollable="true"
                         scrollHeight="300"
                         draggableColumns="true"
                         emptyMessage="No se encontraron registros"
                         filterEvent="enter"
                         filteredValue="#{cuentaBean.listaMovimientosFiltrados}"
                         editable="true">

                <p:ajax event="rowEdit"
                        listener="#{movimientoBean.onRowEdit}"
                        update="@this, #{p:component('messages')}, 
                        :#{p:component('totalesOutputPanel')}"/>

                <p:ajax event="rowEditCancel"
                        listener="#{movimientoBean.onRowCancel}"
                        update="@this, #{p:component('messages')}, 
                        :#{p:component('totalesOutputPanel')}"/>

                <p:ajax event="filter" 
                        update=":#{p:component('totalesOutputPanel')}"/>

                <f:facet name="header">
                    Lista de Movimientos
                    <p:commandButton id="movimientoNewCommandButton"
                                     action="#{movimientoBean.newMovimiento(cuentaBean.cuenta)}"  
                                     icon="ui-icon-plus"
                                     style="float:left; width:20px;height:20px"
                                     process="@this"/>
                </f:facet>

                <p:column headerText="Detalle"
                          filterBy="#{object.detalle}"
                          filterMatchMode="contains"
                          sortBy="#{object.detalle}">
                    
                    <p:cellEditor>
                        <f:facet name="input">
                            <p:inputText value="#{object.detalle}"
                                         required="true"/>
                        </f:facet>
                        <f:facet name="output">
                            <h:outputText value="#{object.detalle}" />
                        </f:facet>
                    </p:cellEditor>
                </p:column>


                <p:column headerText="Monto"
                          filterBy="#{object.monto}"
                          filterMatchMode="contains"
                          sortBy="#{object.monto}">
                    <p:cellEditor>
                        <f:facet name="input">
                            <p:inputNumber id="montoInputText"
                                           value="#{object.monto}"
                                           required="true"
                                           minValue="0"
                                           symbol="¢"
                                           thousandSeparator="."
                                           decimalSeparator=","/>
                        </f:facet>
                        <f:facet name="output">
                            <h:outputText value="#{object.monto}">
                                <f:convertNumber currencySymbol="¢" type="currency"/>
                            </h:outputText>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="Categoria"
                          filterBy="#{object.categoriaMovimientoNombre}"
                          filterMatchMode="contains"
                          sortBy="#{object.categoriaMovimientoNombre}">
                    <p:cellEditor>
                        <f:facet name="input">
                            <p:selectOneMenu id="categoriaMovimientoSelectOneMenu"
                                             value="#{object.idCategoriaMovimiento}"
                                             required="true">
                                <f:selectItems value="#{movimientoBean.llenarCategorias()}"/>
                            </p:selectOneMenu>
                        </f:facet>
                        <f:facet name="output">
                            <h:outputText value="#{object.categoriaMovimientoNombre}" />
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="Tipo"
                          filterBy="#{object.tipoMovimientoNombre}"
                          filterMatchMode="contains"
                          sortBy="#{object.tipoMovimientoNombre}">
                    <p:cellEditor>
                        <f:facet name="input">
                            <p:selectOneMenu id="tipoMovimientoSelectOneMenu"
                                             value="#{object.idTipoMovimiento}">
                                <f:selectItems value="#{movimientoBean.llenarTipos()}"/>
                            </p:selectOneMenu>
                        </f:facet>
                        <f:facet name="output">
                            <h:outputText value="#{object.tipoMovimientoNombre}" />
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="Fecha Movimiento"
                          filterBy="#{object.fechaMovimiento}"
                          filterMatchMode="contains"
                          sortBy="#{object.fechaMovimiento}">
                    <p:cellEditor>
                        <f:facet name="input">
                            <p:calendar id="fechaMovimientoCalendarIn" 
                                        value="#{object.fechaMovimiento}"
                                        showOn="button"
                                        locale="es"
                                        navigator="true"
                                        pattern="dd/MM/yyyy"
                                        required="true"/>
                        </f:facet>
                        <f:facet name="output">
                            <p:calendar id="fechaMovimientoCalendarOut" 
                                        value="#{object.fechaMovimiento}"
                                        showOn="button"
                                        locale="es"
                                        navigator="true"
                                        pattern="dd/MM/yyyy"
                                        disabled="true"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="Fecha Contable"
                          filterBy="#{object.fechaContable}"
                          filterMatchMode="contains"
                          sortBy="#{object.fechaContable}">
                    <p:cellEditor>
                        <f:facet name="input">
                            <p:calendar id="fechaContableMovimientoCalendarIn" 
                                        value="#{object.fechaContable}"
                                        showOn="button"
                                        locale="es"
                                        navigator="true"
                                        pattern="dd/MM/yyyy"
                                        required="true"/>
                        </f:facet>
                        <f:facet name="output">
                            <p:calendar id="fechaContableMovimientoCalendarOut" 
                                        value="#{object.fechaContable}"
                                        showOn="button"
                                        locale="es"
                                        navigator="true"
                                        pattern="dd/MM/yyyy"
                                        disabled="true"/>
                        </f:facet>
                    </p:cellEditor>
                </p:column>

                <p:column headerText="Acciones" style="width:50px">
                    <p:rowEditor/>
                    <p:commandLink id="movimientoEliminaBtn"
                                   styleClass="ui-icon ui-icon-trash"
                                   title="Elimina el movimiento"
                                   action="#{movimientoBean.onDelete(object)}"
                                   update="#{p:component('movimientoDataTable')}, #{p:component('messages')},
                                   :#{p:component('totalesOutputPanel')}"
                                   actionListener="#{cuentaBean.cargaMovimientosCuenta()}"
                                   process="@this"/>
                </p:column>

            </p:dataTable>
            <p:outputPanel id="totalesOutputPanel">
                <h:panelGrid columns="3">
                    <p:outputLabel id='totalIngesosOutputLabel'
                                   value="Total Ingresos"
                                   for="totalIngresosInputText"/>

                    <p:outputLabel id='totalGastosOutputLabel'
                                   value="Total Gastos"
                                   for="totalGastosInputText"/>

                    <p:outputLabel id='saldoOutputLabel'
                                   value="Saldo"
                                   for="saldoInputText"/>

                    <p:inputNumber id="totalIngresosInputText"
                                   value="#{cuentaBean.totalIngresosMontoMovimientos}"
                                   disabled="true"
                                   minValue="0"
                                   symbol="¢"
                                   thousandSeparator="."
                                   decimalSeparator=","/>

                    <p:inputNumber id="totalGastosInputText"
                                   value="#{cuentaBean.totalGastosMontoMovimientos}"
                                   disabled="true"
                                   minValue="0"
                                   symbol="¢"
                                   thousandSeparator="."
                                   decimalSeparator=","/>

                    <p:inputNumber id="saldoInputText"
                                   value="#{cuentaBean.saldoMontoMovimientos}"
                                   disabled="true"
                                   symbol="¢"
                                   thousandSeparator="."
                                   decimalSeparator=","/>
                </h:panelGrid>
            </p:outputPanel>
        </p:panel>

    </ui:define>
</ui:composition>

